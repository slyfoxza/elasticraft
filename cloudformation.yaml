# Copyright 2019 Philip Cronje
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in
# compliance with the License. You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed under the License is
# distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and limitations under the License.
AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.16.0.0/16
      EnableDnsHostnames: false
      EnableDnsSupport: true
      InstanceTenancy: default
      Tags:
      - Key: elasticraft
        Value: vpc
  MinecraftSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref Vpc
      GroupDescription: Minecraft game server security group
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 25565
        ToPort: 25565
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: elasticraft
        Value: minecraftSecurityGroup
  InternetGateway:
    Type: AWS::EC2::InternetGateway
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Ref AWS::StackName
      LaunchTemplateData:
        IamInstanceProfile:
          Arn: !GetAtt InstanceRoleProfile.Arn
        InstanceInitiatedShutdownBehavior: terminate
        InstanceType: c5.large
        TagSpecifications:
        - ResourceType: instance
          Tags:
          - Key: elasticraft
            Value: instance
          - Key: Name
            Value: Elasticraft
        - ResourceType: volume
          Tags:
          - Key: Name
            Value: Elasticraft root volume
  ServerPostApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: server_post.handler
      Runtime: python3.7
      CodeUri: server_post.zip
      Role: !GetAtt ApiFunctionRole.Arn
      Timeout: 30
  ServerPostApiFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ServerPostApiFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*/POST/server
  SnapshotOnShutdownFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: snapshot_on_shutdown.handler
      Runtime: python3.7
      CodeUri: snapshot_on_shutdown.zip
      Tracing: Active
      Role: !GetAtt SnapshotOnShutdownRole.Arn
      Events:
        InstanceTerminateEvent:
          Type: CloudWatchEvent
          Properties:
            Pattern:
              source: [aws.ec2]
              detail-type: [EC2 Instance State-change Notification]
              detail:
                state: [terminated]
  Api:
    Type: AWS::ApiGateway::RestApi
    Properties:
      EndpointConfiguration:
        Types: [REGIONAL]
      Body:
        openapi: 3.0.2
        info:
          title: !Ref AWS::StackName
          version: 1.0.0
        paths:
          "/server":
            post:
              requestBody:
                content:
                  application/json:
                    schema:
                      type: object
                      properties:
                        operation:
                          type: string
                          enum: [start, stop]
                      required: [operation]
                required: true
              responses:
                "200":
                  description: Success
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          ipAddress: { type: string }
                default:
                  description: Generic error
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          message:
                            type: string
              x-amazon-apigateway-request-validator: full
              x-amazon-apigateway-integration:
                type: aws_proxy
                httpMethod: POST
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ServerPostApiFunction.Arn}/invocations
        components:
          securitySchemes:
            sigv4:
              type: apiKey
              name: Authorization
              in: header
              x-amazon-apigateway-authtype: awsSigv4
        security:
        - sigv4: []
        x-amazon-apigateway-request-validators:
          full:
            validateRequestBody: true
            validateRequestParameters: true
  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref Api
      StageName: elasticraft
      StageDescription:
        LoggingLevel: INFO
        TracingEnabled: true
  ApiFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: !Sub /${AWS::StackName}/
      ManagedPolicyArns:
      - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
      - PolicyName: Ec2AccessPolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - ec2:DescribeInstances
            - ec2:DescribeLaunchTemplates
            Resource: "*"
          - Effect: Allow
            Action: ec2:RunInstances
            NotResource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:launch-template/*
            Condition:
              ArnLike:
                ec2:LaunchTemplate: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:launch-template/*
              Bool:
                ec2:IsLaunchTemplateResource: true
          - Effect: Allow
            Action: ec2:RunInstances
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:launch-template/*
            Condition:
              StringEquals:
                ec2:ResourceTag/elasticraft: launchTemplate
          - Effect: Allow
            Action: ec2:CreateTags
            Resource:
            - !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*
            - !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:volume/*
          - Effect: Allow
            Action: iam:PassRole
            Resource: !GetAtt InstanceRole.Arn
          - Effect: Allow
            Action: ec2:TerminateInstances
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*
            Condition:
              StringEquals:
                ec2:ResourceTag/elasticraft: instance
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          Effect: Allow
          Action: sts:AssumeRole
          Principal: { Service: lambda.amazonaws.com }
  SnapshotOnShutdownRole:
    Type: AWS::IAM::Role
    Properties:
      Path: !Sub /${AWS::StackName}/
      ManagedPolicyArns:
      - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      - !Sub arn:${AWS::Partition}:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
      - PolicyName: Ec2AccessPolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - ec2:DescribeInstances
            - ec2:DescribeVolumes
            Resource: "*"
          - Effect: Allow
            Action: ec2:CreateSnapshot
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}::snapshot/*
            Condition:
              StringEquals:
                aws:RequestTag/elasticraft: dataVolumeSnapshot
          - Effect: Allow
            Action: ec2:CreateSnapshot
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:volume/*
            Condition:
              StringEquals:
                ec2:ResourceTag/elasticraft: dataVolume
          - Effect: Allow
            Action: ec2:CreateTags
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}::snapshot/*
            Condition:
              StringEquals:
                ec2:CreateAction: CreateSnapshot
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          Effect: Allow
          Action: sts:AssumeRole
          Principal: { Service: lambda.amazonaws.com }
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      Path: !Sub /${AWS::StackName}/
      Policies:
      - PolicyName: CloudWatchAccessPolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action: cloudwatch:PutMetricData
            Resource: "*"
      - PolicyName: CloudWatchLogsAccessPolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:DescribeLogGroups
            - logs:DescribeLogStreams
            Resource: "*"
          - Effect: Allow
            Action:
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource:
            - !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:cloud-init-output.log:log-stream:*
            - !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:minecraft.log:log-stream:*
      - PolicyName: Ec2AccessPolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - ec2:DescribeInstances
            - ec2:DescribeNetworkInterfaces
            - ec2:DescribeSecurityGroups
            - ec2:DescribeVolumes
            - ec2:ModifyNetworkInterfaceAttribute
            Resource: "*"
          - Effect: Allow
            Action: ec2:AttachVolume
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*
            Condition:
              StringEquals:
                ec2:ResourceTag/elasticraft: instance
          - Effect: Allow
            Action: ec2:AttachVolume
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:volume/*
            Condition:
              StringEquals:
                ec2:ResourceTag/elasticraft: dataVolume
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          Effect: Allow
          Action: sts:AssumeRole
          Principal: { Service: ec2.amazonaws.com }
  InstanceRoleProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: !Sub /${AWS::StackName}/
      Roles:
      - !Ref InstanceRole
