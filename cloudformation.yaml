# Copyright 2019 Philip Cronje
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in
# compliance with the License. You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed under the License is
# distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and limitations under the License.
AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Resources:
  ServerPostApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: server_post.handler
      Runtime: python3.7
      CodeUri: server_post.py.zip
      Role: !GetAtt ApiFunctionRole.Arn
      Timeout: 20
  ServerPostApiFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ServerPostApiFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*/POST/server
  Api:
    Type: AWS::ApiGateway::RestApi
    Properties:
      EndpointConfiguration:
        Types: [REGIONAL]
      Body:
        openapi: 3.0.2
        info:
          title: !Ref AWS::StackName
          version: 1.0.0
        paths:
          "/server":
            post:
              requestBody:
                content:
                  application/json:
                    schema:
                      type: object
                      properties:
                        operation:
                          type: string
                          enum: [start, stop]
                      required: [operation]
                required: true
              responses:
                "200":
                  description: Success
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          ipAddress: { type: string }
                default:
                  description: Generic error
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          message:
                            type: string
              x-amazon-apigateway-request-validator: full
              x-amazon-apigateway-integration:
                type: aws_proxy
                httpMethod: POST
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ServerPostApiFunction.Arn}/invocations
        components:
          securitySchemes:
            sigv4:
              type: apiKey
              name: Authorization
              in: header
              x-amazon-apigateway-authtype: awsSigv4
        security:
        - sigv4: []
        x-amazon-apigateway-request-validators:
          full:
            validateRequestBody: true
            validateRequestParameters: true
  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref Api
      StageName: elasticraft
  ApiFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: !Sub /${AWS::StackName}/
      ManagedPolicyArns:
      - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
      - PolicyName: Ec2AccessPolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - ec2:DescribeInstances
            - ec2:DescribeLaunchTemplates
            Resource: "*"
          - Effect: Allow
            Action: ec2:RunInstances
            NotResource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:launch-template/*
            Condition:
              ArnLike:
                ec2:LaunchTemplate: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:launch-template/*
              Bool:
                ec2:IsLaunchTemplateResource: true
          - Effect: Allow
            Action: ec2:RunInstances
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:launch-template/*
            Condition:
              StringEquals:
                ec2:ResourceTag/elasticraft: launchTemplate
          - Effect: Allow
            Action: ec2:CreateTags
            Resource:
            - !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*
            - !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:volume/*
          - Effect: Allow
            Action: iam:PassRole
            # FIXME
            Resource: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/Elasticraft/*
          - Effect: Allow
            Action: ec2:TerminateInstances
            Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*
            Condition:
              StringEquals:
                ec2:ResourceTag/elasticraft: instance
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          Effect: Allow
          Action: sts:AssumeRole
          Principal: { Service: lambda.amazonaws.com }
